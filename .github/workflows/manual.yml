# This is a basic workflow that is manually triggered

name: Manual workflow

# Controls when the action will run. Workflow runs when manually triggered using the UI
# or API.
on:
  workflow_dispatch:

jobs:
  neovim-aarch64-build:
    runs-on: ubuntu-latest
    name: Build neovim for arm64 architecture
    steps:
    - uses: uraimo/run-on-arch-action@v2.5.0
      id: runcmd
      with:
        arch: aarch64
        distro: ubuntu_latest
        setup: |
            mkdir -p "${PWD}/artifacts"
        dockerRunArgs: |
            --volume "${PWD}/artifacts:/artifacts"
        install: | 
            apt-get update -y 
            apt-get -y install ninja-build gettext cmake unzip curl git
        
        run: |
            curl -o appimagetool https://github.com/AppImage/AppImageKit/releases/download/13/appimagetool-aarch64.AppImage
            chmod a+x appimagetool
            git clone --branch master --depth 1 'https://github.com/neovim/neovim.git'
            cd ./neovim
            make CMAKE_BUILD_TYPE=RelWithDebInfo CMAKE_INSTALL_PREFIX='./compiled/usr'
            make install
            cd ./compiled
            echo '#!/bin/bash' >> AppRun
            echo 'unset ARGV0' >> AppRun
            echo 'exec "$(dirname "$(readlink  -f "${0}")")/usr/bin/nvim" ${@+"$@"}' >> AppRun
            chmod a+x AppRun
            ln -s ./usr/share/applications/nvim.desktop nvim.desktop
            ln -s ./usr/share/icons/hicolor/128x128/apps/nvim.png nvim.png
            cd ../../
            appimagetool ./neovim/compiled/ nvim-rolling.appimage
            chmod a+x nvim-rolling.appimage
            cp nvim-rolling.appimage "/artifacts/nvim-rolling.appimage"
